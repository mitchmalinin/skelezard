<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }
      img {
        display: block;
        margin: auto;
        max-width: 100%;
        max-height: 100%;
      }
    </style>
    <meta charset="utf-8" />
    <script>
      let imgSrc = "./skull.png"

      const typedWord = []
      const hexArray = []
      let startGlitch = false
      const glitch = [71, 76, 73, 84, 67, 72]
      const canvas = document.createElement("canvas")
      const ctx = canvas.getContext("2d")

      const toHex = (n) => {
        const hex = n.toString(16)
        return hex.length == 1 ? "0" + hex : hex
      }

      // glitch the hex array by shifting sections up or down by a random amount
      const glitchHorizontal = (img) => {
        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
        const numSections = 10
        const sectionSize = Math.floor(hexArray.length / numSections)
        const maxShift = sectionSize * 2
        for (let i = 0; i < numSections; i++) {
          const sectionStart = i * sectionSize
          const sectionEnd = sectionStart + sectionSize
          const shift = Math.floor(Math.random() * maxShift * 2) - maxShift
          hexArray.copyWithin(
            sectionStart,
            sectionStart + shift,
            sectionEnd + shift
          )
        }

        if (hexArray.length > 0) {
          for (let i = 0; i < imageData.data.length; i += 4) {
            const hex = hexArray[i / 4]
            const r = parseInt(hex.substring(1, 3), 16)
            const g = parseInt(hex.substring(3, 5), 16)
            const b = parseInt(hex.substring(5, 7), 16)
            imageData.data[i] = r
            imageData.data[i + 1] = g
            imageData.data[i + 2] = b
          }
        }
        console.log("imgData", imageData)
        ctx.putImageData(imageData, 0, 0)
        const dataUrl = canvas.toDataURL("image/jpeg")
        img.src = dataUrl
      }

      const glitchVertical = (img) => {
        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
        const numRows = 10
        const rowSize = canvas.width
        const maxShift = rowSize * 2
        for (let i = 0; i < numRows; i++) {
          const rowStart = i * rowSize
          const rowEnd = rowStart + rowSize
          const shift = Math.floor(Math.random() * maxShift * 2) - maxShift
          hexArray.copyWithin(rowStart, rowStart + shift, rowEnd + shift)
        }

        if (hexArray.length > 0) {
          for (let i = 0; i < imageData.data.length; i += 4) {
            const hex = hexArray[i / 4]
            const r = parseInt(hex.substring(1, 3), 16)
            const g = parseInt(hex.substring(3, 5), 16)
            const b = parseInt(hex.substring(5, 7), 16)
            imageData.data[i] = r
            imageData.data[i + 1] = g
            imageData.data[i + 2] = b
          }
        }
        console.log("imgData", imageData)
        ctx.putImageData(imageData, 0, 0)
        const dataUrl = canvas.toDataURL("image/jpeg")
        img.src = dataUrl
      }

      const createImageAndHexArray = (img) => {
        // create a canvas element to draw the glitched image
        const imgObj = new Image()
        imgObj.src = imgSrc

        imgObj.onload = () => {
          canvas.width = imgObj.width
          canvas.height = imgObj.height
          ctx.drawImage(imgObj, 0, 0)
          let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
          const data = imageData.data
          if (data.length) {
            for (let i = 0; i < data.length; i += 4) {
              const r = data[i]
              const g = data[i + 1]
              const b = data[i + 2]
              const hex = `#${toHex(r)}${toHex(g)}${toHex(b)}`
              hexArray.push(hex)
            }
            if (hexArray.length > 0) {
              for (let i = 0; i < imageData.data.length; i += 4) {
                const hex = hexArray[i / 4]
                const r = parseInt(hex.substring(1, 3), 16)
                const g = parseInt(hex.substring(3, 5), 16)
                const b = parseInt(hex.substring(5, 7), 16)
                imageData.data[i] = r
                imageData.data[i + 1] = g
                imageData.data[i + 2] = b
              }
            }
            ctx.putImageData(imageData, 0, 0)
            const dataUrl = canvas.toDataURL("image/jpeg")
            img.src = dataUrl
          }
        }
      }

      window.onload = () => {
        const img = document.getElementById("skelezard")

        createImageAndHexArray(img)

        document.getElementById("horizontal-btn").onclick = () => {
          glitchHorizontal(img)
        }
        document.getElementById("vertical-btn").onclick = () => {
          glitchHorizontal(img)
        }
        document.getElementById("reset-btn").onclick = () => {
          createImageAndHexArray(img)
        }

        document.body.onkeyup = function (e) {
          console.log("running")

          if ((e.keycode = 32)) {
            if (startGlitch) {
            }
          } else {
            typedWord.push(e.keyCode)
            if (typedWord.length >= 6) {
              const sliced = typedWord.slice(-6)
              if (JSON.stringify(sliced) == JSON.stringify(glitch)) {
                startGlitch = true
                liarImage.src =
                  base + images[Math.floor(Math.random() * images.length)]
              }
            }
          }
        }
      }
    </script>
  </head>
  <body>
    <img id="skelezard" src="" alt="Glitched Image" />
    <button id="vertical-btn">glitch vertical</button>
    <button id="horizontal-btn">glitch horizontal</button>
    <button id="reset-btn">reset</button>
  </body>
</html>
